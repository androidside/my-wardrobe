rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if two users are friends
    function areFriends(userId1, userId2) {
      return exists(/databases/$(database)/documents/users/$(userId1)/friends/$(userId2));
    }
    
    match /users/{userId} {
      // Users can read/write their own document
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Allow username queries for availability checks (including during signup)
      // This is safe because usernames are meant to be public for social features
      allow list: if true;
      
      // Legacy wardrobe collection (singular)
      match /wardrobe/{itemId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Wardrobes collection
      match /wardrobes/{wardrobeId} {
        // Users can read/write their own wardrobes
        allow read, write: if request.auth != null && request.auth.uid == userId;
        
        // Friends can read shareable wardrobes
        allow get: if request.auth != null 
          && areFriends(userId, request.auth.uid)
          && resource.data.isShareable == true;
        
        // Friends can list shareable wardrobes
        allow list: if request.auth != null 
          && areFriends(userId, request.auth.uid);
        
        // Clothing items within wardrobes
        match /items/{itemId} {
          // Users can read/write their own items
          allow read, write: if request.auth != null && request.auth.uid == userId;
          
          // Friends can read items in shareable wardrobes
          allow get: if request.auth != null 
            && areFriends(userId, request.auth.uid)
            && get(/databases/$(database)/documents/users/$(userId)/wardrobes/$(wardrobeId)).data.isShareable == true;
          
          // Friends can list items in shareable wardrobes
          allow list: if request.auth != null 
            && areFriends(userId, request.auth.uid)
            && get(/databases/$(database)/documents/users/$(userId)/wardrobes/$(wardrobeId)).data.isShareable == true;
        }
      }
      
      // Friends collection
      match /friends/{friendId} {
        // Users can read/write their own friends
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // Friend requests collection
      match /friendRequests/{requestId} {
        // Users can read their own sent and received requests
        allow read: if request.auth != null 
          && (request.auth.uid == userId 
            || request.auth.uid == resource.data.fromUserId
            || request.auth.uid == resource.data.toUserId);
        
        // Users can create requests from themselves
        allow create: if request.auth != null 
          && request.auth.uid == request.resource.data.fromUserId;
        
        // Users can update requests sent to them (accept/reject)
        allow update: if request.auth != null 
          && request.auth.uid == resource.data.toUserId;
        
        // Users can delete their own sent requests
        allow delete: if request.auth != null 
          && request.auth.uid == resource.data.fromUserId;
      }
    }
  }
}
